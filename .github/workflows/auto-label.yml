name: Auto-label Issues

on:
  issues:
    types: [opened, edited]

jobs:
  add-label:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Issue Fields
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAT_SECRET }}
          script: |
            const issue = context.payload.issue;
            const body = issue.body;

            function extractCheckboxList(fieldName) {
              const regex = new RegExp(`${fieldName}\\n\\n((?:- \\[x\\] .+\\n?)+)`);
              const match = body.match(regex);
              if (!match) return [];

              return match[1]
                .split("\n") // Split into lines
                .map(line => line.replace(/- \[x\] /, "").trim()) // Remove checkbox markers
                .filter(Boolean); // Remove empty values
            }

            function extractDropdown(fieldName) {
              const regex = new RegExp(`${fieldName}\\n\\n(.+)`);
              const match = body.match(regex);
              return match ? match[1].trim() : null;
            }

            const selectedCategories = extractCheckboxList("ðŸ”¹ Select Issue Category");  // âœ… Extract multiple categories
            const organization = extractDropdown("ðŸ¢ Select Organization");  // âœ… Extract single organization

            console.log(`Extracted Categories: ${selectedCategories}`);
            console.log(`Extracted Organization: ${organization}`);

            const categoryToLabelMap = {
              "Reprocess request": "Reprocess request",
              "QC queries": "QC queries",
              "Phy file queries": "Phy file queries",
              "Hex file queries": "Hex file queries",
              "Meta files queries": "Meta file queries",
              "Traj file queries": "Traj file queries",
              "GDAC queries": "GDAC queries",
              "GTS queries": "GTS queries",
              "NCEI queries": "NCEI queries",
              "General queries": "General queries",
              "PI queries": "PI queries",
              "Core queries": "Core queries",
              "Deep queries": "Deep queries",
              "BGC queries": "BGC queries",
              "Polar queries": "Polar queries",
              "Ticketing queries": "Ticketing queries"
            };

            const organizationToLabelMap = {
              "AOML": "AOML",
              "SIO": "SIO",
              "MBARI": "MBARI",
              "UW": "UW",
              "WHOI": "WHOI",
              "PMEL": "PMEL",
              "NAVO": "NAVO",
              "UH": "UH",
              "MIT": "MIT",
              "JPL": "JPL",
              "NDBC": "NDBC",
              "FSU": "FSU",
              "Navoceano": "Navoceano",
              "UMaine": "UMaine",
              "iFremer": "iFremer",
              "Coriolis": "Coriolis",
              "NCEI": "NCEI",
              "Other National": "Other National",
              "Other International": "Other International"
            };

            const labels = [];

            // âœ… Map each selected category to its label
            selectedCategories.forEach(category => {
              if (categoryToLabelMap[category]) {
                labels.push(categoryToLabelMap[category]);
              }
            });

            // âœ… Map organization to its label
            if (organizationToLabelMap[organization]) {
              labels.push(organizationToLabelMap[organization]);
            }

            // âœ… Apply labels if found
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
              console.log(`Labels added: ${labels.join(", ")}`);
            } else {
              console.log("No matching labels found.");
            }
