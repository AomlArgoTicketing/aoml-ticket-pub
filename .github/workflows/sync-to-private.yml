name: Sync Public Issues to Private Repo

on:
  issues:
    types: [opened]

jobs:
  sync_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Create Issue in Private Repo and Add Label
        env:
          GH_TOKEN: ${{ secrets.PAT_SECRET }}
          PUBLIC_ISSUE_NUMBER: ${{ github.event.issue.number }}
          PUBLIC_REPO: "TicketTesting77/aoml-ticket-pub"
          PRIVATE_REPO: "TicketTesting77/aoml-internal-tracking"

        run: |
          echo "üîÑ Syncing issue #$PUBLIC_ISSUE_NUMBER from $PUBLIC_REPO to $PRIVATE_REPO"

          # Create a new issue in the private repo
          NEW_ISSUE=$(curl -s -X POST -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{
              \"title\": \"[Synced] ${{ github.event.issue.title }}\",
              \"body\": \"This issue was automatically synced from $PUBLIC_REPO.\\n\\n**Original Public Issue:** #$PUBLIC_ISSUE_NUMBER (https://github.com/$PUBLIC_REPO/issues/$PUBLIC_ISSUE_NUMBER)\\n\\n${{ github.event.issue.body }}\"
            }" \
            "https://api.github.com/repos/$PRIVATE_REPO/issues")

          # Extract the new private issue number
          PRIVATE_ISSUE_NUMBER=$(echo "$NEW_ISSUE" | jq -r '.number')

          if [[ -z "$PRIVATE_ISSUE_NUMBER" || "$PRIVATE_ISSUE_NUMBER" == "null" ]]; then
            echo "‚ùå Failed to create issue in private repo."
            exit 1
          fi

          echo "‚úÖ Created issue #$PRIVATE_ISSUE_NUMBER in $PRIVATE_REPO"

          # Add a label in the private repo to track the public issue
          LABEL_NAME="linked-public-issue-$PUBLIC_ISSUE_NUMBER"
          curl -s -X POST -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{
              \"labels\": [\"$LABEL_NAME\"]
            }" \
            "https://api.github.com/repos/$PRIVATE_REPO/issues/$PRIVATE_ISSUE_NUMBER"

          echo "‚úÖ Added label \"$LABEL_NAME\" to issue #$PRIVATE_ISSUE_NUMBER in $PRIVATE_REPO"
